<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2016-11-23">

<title>Create an interactive web map with geotagged photos – Seascapemodels</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-f93c2b1f3f0577f377aefa4848a86a36.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/quarto-contrib/fontawesome6-6.7.2/all.min.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/fontawesome6-6.7.2/latex-fontsize.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed fullcontent quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Seascapemodels</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../bluecology_blog.html"> 
<span class="menu-text"><i class="fa-regular fa-newspaper" aria-label="newspaper"></i> Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../people.html"> 
<span class="menu-text"><i class="fa-regular fa-user" aria-label="user"></i> People</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../code.html"> 
<span class="menu-text"><i class="fa-solid fa-laptop-code" aria-label="laptop-code"></i> R tutorials</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://scholar.google.com.au/citations?hl=en&amp;user=1qG6yFMAAAAJ&amp;view_op=list_works&amp;sortby=pubdate"> 
<span class="menu-text"><i class="fa-brands fa-google-scholar" aria-label="google-scholar"></i></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://discover.utas.edu.au/C.J.Brown"> 
<span class="menu-text"><i class="fa-solid fa-building-columns" aria-label="building-columns"></i></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/cbrown5"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://bsky.app/profile/bluecology.bsky.social"> 
<span class="menu-text"><i class="fa-brands fa-bluesky" aria-label="bluesky"></i></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/christopher-brown-32466785/"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Create an interactive web map with geotagged photos</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">rstats</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">November 23, 2016</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<section id="part-2-create-an-interactive-web-map-with-geotagged-photos" class="level2">
<h2 class="anchored" data-anchor-id="part-2-create-an-interactive-web-map-with-geotagged-photos">Part 2: Create an interactive web map with geotagged photos</h2>
<p>See the other <a href="../../rstats/2016/11/14/photos-to-spatialstat.html">parts in this series of blog posts</a>.</p>
<p>In part 1 we looked at making a simple interactive map using locations from our geotagged photos. Those photos have data associated with them (counts of oysters in quadrats) so here we will look at how you would plot that data on your map.</p>
<p>We will also add a geo-referenced pop-up that includes a picture of our study site. You might be familiar with this idea from Google Earth or Flickr.</p>
<p>To get you excited, here is the end result (try clicking on things! If you are viewing this blog on Rbloggers you will need to go <a href="http://www.seascapemodels.org/data/hornby_oysters_map.html">here</a> to see the map):</p>
<iframe src="../../data/hornby_oysters_map.html" style="width: 95%; height: 30em">
It no map appears here your browser doesn’t support iframes. Try <a href = "/data/hornby_oysters_map.html">this link instead</a>
</iframe>
<section id="getting-started" class="level3">
<h3 class="anchored" data-anchor-id="getting-started">Getting started</h3>
<p>First up here are the packages we need:</p>
<pre><code>library(leaflet)
library(exifr)</code></pre>
<p>The next list of packages is optional, but I will use here to make data processing more convenient:</p>
<pre><code>library(readr) #for the updated version of read.csv
library(dplyr) #for data wrangling
library(stringr) #for wrangling strings</code></pre>
<p>Finally to get some nice colours:</p>
<pre><code>library(RColorBrewer)</code></pre>
<p>Now load in the data. I am using <code>read_csv</code> which comes from the <code>readr</code> package. <code>read_csv</code> is a modernised version of the base R function <code>read.csv</code>. Here are the <a href="../../data/Exifdata.csv">exif data</a> and associated <a href="../../data/oysters_data.csv">oyster counts</a> if you are repeating this example.</p>
<pre><code>edat &lt;- read_csv('Exifdata.csv')
odat &lt;- read_csv('oyster_data.csv')
n &lt;- nrow(odat) #number of sample sites</code></pre>
</section>
<section id="joining-the-locations-to-the-counts" class="level3">
<h3 class="anchored" data-anchor-id="joining-the-locations-to-the-counts">Joining the locations to the counts</h3>
<p>Now we need to join our counts of oysters to the locations. We can match by the picture numbers, which I recorded when I counted the oysters. First up we need to clean the clean the picture numbers in the exif data to remove the leading ‘DSC_’. We do this using <code>mutate</code> from <code>dplyr</code> and <code>str_extract</code> from <code>stringr</code> to extract the first four digits in each picture’s filename.</p>
<pre><code>edat&lt;- edat %&gt;%
mutate(pic_num =
    as.numeric(
        str_extract(SourceFile, '\\d\\d\\d\\d')
        ))</code></pre>
<p>If you haven’t seen <code>%&gt;%</code> before it is a ‘pipe’ that puts the dataframe <code>edat</code> into the first argument of our <code>mutate</code> function. The pipe isn’t essential, but I think it improves readibility. See <a href="http://r4ds.had.co.nz/pipes.html">Wickham’s book</a> for more guidance on pipes.</p>
<p>Now we can join the oysters and pictures. <code>left_join</code> will automatically identify <code>pic_num</code> to join on, because it is the common column across both dataframes:</p>
<pre><code>dat &lt;- odat %&gt;%
  left_join(edat)</code></pre>
</section>
<section id="create-the-content-for-the-pop-up-image" class="level3">
<h3 class="anchored" data-anchor-id="create-the-content-for-the-pop-up-image">Create the content for the pop-up image</h3>
<p>To create the pop-up you need to know a little bit of html. There is plenty of helpful guides on the web and html is pretty simple to learn. The pop-up will show an image and some text. Here we define the content:</p>
<pre><code>content &lt;- paste(sep = "&lt;br/&gt;",
"&lt;img src='http://www.seascapemodels.orgintertidal_scene.JPG'
   style='width:230px;height:300px;'&gt;",
"The intertidal zone",
"at Hornby Island"
)</code></pre>
<p>In short we have specified a string with some html code. <code>&lt;br/&gt;</code> html tag creates a new line. The <code>&lt;img&gt;</code> tag specifies the insertion of an image (the link gives the image’s location, which is on my webpage. We have also set the width and height of the image. Then we follow with a bit of text explaining the image.</p>
<p>We will use <code>content</code> in our <code>leaflet</code> map below.</p>
<p>We also need the location to place our pop-up. Because the image is gps tagged, we can extract the gps locations from the exif data. Download the image from the link given above in <code>content</code> then you can get the exif data associated with it like this:</p>
<pre><code>scene &lt;- exifr('intertidal_scene.JPG')
x1 &lt;- scene $GPSLongitude
y1 &lt;- scene $GPSLatitude</code></pre>
<p>We now have coordinates for the pop-up in our <code>leaflet</code> map.</p>
</section>
<section id="colour-scale-for-the-oyster-counts" class="level3">
<h3 class="anchored" data-anchor-id="colour-scale-for-the-oyster-counts">Colour scale for the oyster counts</h3>
<p><code>leaflet</code> has some pretty convenient functions for creating nice colour scales. Here we use <code>colourBin</code> to bin counts of oysters into different categories that we set in the vector <code>brks</code>:</p>
<pre><code>brks &lt;- c(0,1, 5, 10, 20, 70)
ncol &lt;- length(brks)-1
oystercols &lt;- c('grey20',brewer.pal(ncol-1, 'Purples'))
pal &lt;- colorBin(oystercols, dat$oysters_live, bins = brks)</code></pre>
<p>The end result <code>pal</code> is a function that will generate a colour palette when some data is input to it.</p>
</section>
<section id="make-a-map-with-images" class="level3">
<h3 class="anchored" data-anchor-id="make-a-map-with-images">Make a map with images</h3>
<p>We have prepped our data, so now the fun bit, making the map! This map is somewhat complicated so I will step you through it using our friend ‘pipes’ (the full code without text breaks is below if you want to cut and paste). Note how convenient pipes are here, we can essentially just layer up our map data in an intuitive fashion.</p>
<pre><code>mapout &lt;- leaflet(dat) %&gt;%</code></pre>
<p>We name our map and set the dataframe it will use.</p>
<pre><code>addProviderTiles("Esri.WorldImagery") %&gt;%</code></pre>
<p>Set’s the background (a satellite image)</p>
<pre><code>setView(lng = x1, lat = y1, zoom = 16) %&gt;%</code></pre>
<p>Chooses the region to zoom into. <code>leaflet</code> will guess the zoom level from our dataframe, but we have more control if we choose the region. The default here was a higher zoom level where the tiles don’t render when using Esri.WorldImagery.</p>
<p>Now we add some markers, setting their colours using oyster counts:</p>
<pre><code>addCircleMarkers(~ GPSLongitude, ~ GPSLatitude,
    color = 'white',opacity =1, weight = 1,
fillColor = ~pal(oysters_live),
popup = as.character(dat$oysters_live),
fillOpacity = 0.8,
radius = 6) %&gt;%</code></pre>
<p>This looks complex, but it is just a series of simple commands. <code>~ GPSLongitude</code> tells leaflet which column of <code>dat</code> is longitude. <code>color</code>, <code>opacity</code> and <code>weight</code> refer to the colour, opacity (solid in this case) and width of the border of the markers. <code>fillColor</code> uses our palette and applies it the <code>oysters_live</code> column of <code>dat</code>. <code>popup</code> creates a popup when we click on a marker, which gives the number of oysters. <code>fillOpacity</code> and radius refer to the fill of the markers.</p>
<p>We will also add a marker for the picture I took of the shoreline. Note that this time I use our <code>content</code> data created above to specify what goes in the popup. We also change some of the marker options with <code>options</code>. See <code>?markerOptions</code> for other options:</p>
<pre><code>addMarkers(x1, y1, popup = content,
    options = markerOptions(opacity = 0.9, draggable=T)) %&gt;%</code></pre>
<p>Now let’s add a legend:</p>
<pre><code>addLegend("topright", pal = pal,
values = brks,
title = "Number of live oysters
&lt;a href = 'https://en.wikipedia.org/wiki/Pacific_oyster' target = '_blank'&gt; (Crassostrea gigas)&lt;/a&gt;",
opacity = 1)</code></pre>
<p>the nice thing about using <code>colorBin</code> to create our colours is we can map them directly to the legend, as we have done here with <code>pal = pal</code> (telling leaflet to use our <code>pal</code> function for the colour palette). Note in the <code>title</code> command we have also inserted some more html, this time a <code>&lt;a&gt;</code> tag which just turns the species name ‘(Crassostrea gigas)’ into a link to the Wikipedia page for the Pacific oyster.</p>
<p>And that’s it. Run that code then type <code>mapout</code> to print your map. Next up we will look at how to build a <a href="../../rstats/2016/11/14/photos-to-spatialstat.html">spatial model using this data</a>.</p>
</section>
<section id="extra-task-getting-the-map-on-your-webpage" class="level3">
<h3 class="anchored" data-anchor-id="extra-task-getting-the-map-on-your-webpage">Extra task: Getting the map on your webpage</h3>
<p>If you want to save the map to use on your own page, you can do so with the <code>htmlwidgets</code> package, like this:</p>
<pre><code>htmlwidgets::saveWidget(mapout, file = 'hornby_oysters_map.html', selfcontained = F, libdir = "leafletmap_files")</code></pre>
<p>I recommend using `<code>so that the javascript files that create the map are stored in a seperate folder, rather than the javascript code being included within the html page (which makes it a very long file).  Also, if you set the</code>libdir<code>command the javascript files will be saved in the folder specified by</code>libdir` and all the references to the javascript on the html page (which has the map) will be to that folder (in this case: ‘/leafletmap_files/’). If you are putting multiple maps on your webpage, always use the same libdir and you will only need one copy of the leaflet javascript (under libdir) in your page’s data files. Poke around in <a href="https://github.com/cbrown5/cbrown5.github.io">github.com/cbrown5/cbrown5.github.io</a> if you want to see how this works. I keep the leaflat maps in the <a href="https://github.com/cbrown5/cbrown5.github.io/tree/master/data">data</a> folder.</p>
</section>
<section id="map-code-as-one-block-for-cutting-and-pasting" class="level3">
<h3 class="anchored" data-anchor-id="map-code-as-one-block-for-cutting-and-pasting">Map code as one block for cutting and pasting</h3>
<pre><code>mapout &lt;- leaflet(dat) %&gt;%
#Use satellite image as base
addProviderTiles("Esri.WorldImagery") %&gt;%
setView(lng = x1, lat = y1, zoom = 16) %&gt;%
#Add markers for oyster quadrats
addCircleMarkers(~ GPSLongitude, ~ GPSLatitude,
    color = 'white',opacity =1, weight = 1,
    fillColor = ~pal(oysters_live),
    popup = as.character(dat$oysters_live),
    fillOpacity = 0.8,
    radius = 6) %&gt;% # add a popup for number of oysters
    #Add marker showing a picture of the survey site
    addMarkers(x1, y1, popup = content,
        options = markerOptions(opacity = 0.9, draggable=T)) %&gt;%
        #Add a legend
        addLegend("topright", pal = pal,
        values = brks,
        title = "Number of live oysters
        &lt;a href = 'https://en.wikipedia.org/wiki/Pacific_oyster' target = '_blank'&gt; (Crassostrea gigas)&lt;/a&gt;",
        opacity = 1)</code></pre>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/www\.seascapemodels\.org");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>