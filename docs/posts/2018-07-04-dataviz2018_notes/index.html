<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2018-07-04">

<title>A brief guide to data visuals in R in 2018 – Seascapemodels</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-f93c2b1f3f0577f377aefa4848a86a36.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/quarto-contrib/fontawesome6-6.7.2/all.min.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/fontawesome6-6.7.2/latex-fontsize.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed fullcontent quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Seascapemodels</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../bluecology_blog.html"> 
<span class="menu-text"><i class="fa-regular fa-newspaper" aria-label="newspaper"></i> Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../people.html"> 
<span class="menu-text"><i class="fa-regular fa-user" aria-label="user"></i> People</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../code.html"> 
<span class="menu-text"><i class="fa-solid fa-laptop-code" aria-label="laptop-code"></i> R tutorials</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://scholar.google.com.au/citations?hl=en&amp;user=1qG6yFMAAAAJ&amp;view_op=list_works&amp;sortby=pubdate"> 
<span class="menu-text"><i class="fa-brands fa-google-scholar" aria-label="google-scholar"></i></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://discover.utas.edu.au/C.J.Brown"> 
<span class="menu-text"><i class="fa-solid fa-building-columns" aria-label="building-columns"></i></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/cbrown5"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://bsky.app/profile/bluecology.bsky.social"> 
<span class="menu-text"><i class="fa-brands fa-bluesky" aria-label="bluesky"></i></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/christopher-brown-32466785/"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">A brief guide to data visuals in R in 2018</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">rstats</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">July 4, 2018</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<section id="data-visuals-in-r-2018" class="level2">
<h2 class="anchored" data-anchor-id="data-visuals-in-r-2018">Data visuals in R 2018</h2>
<p>Here are the notes from my talk on dataviz at the 2018 <a href="http://bioinformatics.org.au/winterschool/">UQ Winterschool in Bioinformatics</a>.</p>
<p>These notes run through some of the principles I present and also show R code for generating data visuals.</p>
<p>If you want to take the dataviz quiz first, then <a href="https://docs.google.com/forms/d/e/1FAIpQLSd5v5d15q8KO7VyfjRRrfGV1NadKVyLpyAdzqu2Fvreq40UXg/viewform">click here</a>. We will look at the results later using R.</p>
<p>{% include r-courses-ad.html %}</p>
</section>
<section id="graphics-packages-in-r" class="level2">
<h2 class="anchored" data-anchor-id="graphics-packages-in-r">Graphics packages in R</h2>
<p>The dominant options are the base graphics R comes shipped with and the <code>ggplot2</code> package.</p>
<p><img src="dataviz2018_notes_files/figure-markdown_strict/unnamed-chunk-1-1.png" class="img-fluid"></p>
</section>
<section id="plot-your-data" class="level2">
<h2 class="anchored" data-anchor-id="plot-your-data">Plot your data</h2>
<section id="make-your-own-datasaurus-dozen" class="level3">
<h3 class="anchored" data-anchor-id="make-your-own-datasaurus-dozen">Make your own Datasaurus dozen</h3>
<p>The datasaurus is a great example of why you should view your data, invented by Alberto Cairo. See Steph Locke’s code and package on <a href="https://github.com/stephlocke/datasauRus">github</a> for making this in R.</p>
<pre><code>library(datasauRus)
datnames &lt;- rev(unique(datasaurus_dozen$dataset))
nlevels &lt;- length(datnames)

for (i in 1:nlevels){
  i &lt;- which(datasaurus_dozen$dataset == datnames[i])
  plot(datasaurus_dozen$x[i], datasaurus_dozen$y[i],
     xlab = "x", ylab = "y",   las = 1)
  Sys.sleep(1)
}</code></pre>
<p><img src="datasaurus_pause.gif" class="img-fluid"></p>
<p>Convince yourself that the mean, sd and correlation is the same in all of these plots:</p>
<pre><code>library(dplyr)
datasaurus_dozen %&gt;% group_by(dataset) %&gt;%
    summarize(meanx = mean(x), meany = mean(y),
              sdx = sd(x), sdy = sd(y),
              corr = cor(x,y))</code></pre>
<p>We can also save these as .png images to make a .gif image (see also <a href="http://www.seascapemodels.org/rstats/2017/05/14/timeseries-uncertainty-gif.html">here</a>)</p>
<pre><code>for (ilvs in 1:nlevels){
  i &lt;- which(datasaurus_dozen$dataset == datnames[ilvs])
  thiscol &lt;- ifelse(datnames[ilvs] == "dino", "darkseagreen", "grey20")
  png(filename = paste0("datasaurus/",datnames[ilvs],".png"))
  plot(datasaurus_dozen$x[i], datasaurus_dozen$y[i],
     xlab = "x", ylab = "y",   las = 1,
      xlim = c(10, 105), ylim = c(-5, 105), col = thiscol, pch = 16)
  dev.off()
}</code></pre>
</section>
</section>
<section id="clarity-not-simplicity" class="level2">
<h2 class="anchored" data-anchor-id="clarity-not-simplicity">Clarity not simplicity</h2>
<p>I give the example of the famous <a href="http://onlinelibrary.wiley.com/doi/10.1029/1999GL900070/abstract">‘hockey stick’ graph of Northern Hemisphere temperatures</a>.</p>
</section>
<section id="dataviz-are-models" class="level2">
<h2 class="anchored" data-anchor-id="dataviz-are-models">Dataviz are models</h2>
<blockquote class="blockquote">
<p>Any visualization is a model</p>
</blockquote>
<p>Alberto Cairo 2016</p>
<section id="different-viz-models-for-the-same-data" class="level3">
<h3 class="anchored" data-anchor-id="different-viz-models-for-the-same-data">Different viz models for the same data</h3>
</section>
<section id="three-ways-of-visualising-the-same-x-y-data" class="level3">
<h3 class="anchored" data-anchor-id="three-ways-of-visualising-the-same-x-y-data">Three ways of visualising the same x-y data</h3>
<p>Each of these graphs of the same data has a slightly different interpretation.</p>
<pre><code>x &lt;- 1:100
y &lt;- x + rnorm(100, sd=30)
plot(x,y, pch = 16, col = grey(0.5, 0.5))</code></pre>
<p><img src="dataviz2018_notes_files/figure-markdown_strict/unnamed-chunk-6-1.png" class="img-fluid"></p>
<pre><code>mod1 &lt;- lm(y ~ x)
plot(x,y, col = 'white')
abline(mod1, lwd = 3, col = 'red')</code></pre>
<p><img src="dataviz2018_notes_files/figure-markdown_strict/unnamed-chunk-6-2.png" class="img-fluid"></p>
<pre><code>library(MASS)
filled.contour(kde2d(x,y), scale = F)</code></pre>
<p><img src="dataviz2018_notes_files/figure-markdown_strict/unnamed-chunk-6-3.png" class="img-fluid"></p>
<pre><code>plot(x,y, pch = 16, col = grey(0.5, 0.5))
abline(mod1, lwd = 3, col = 'red')</code></pre>
<p><img src="dataviz2018_notes_files/figure-markdown_strict/unnamed-chunk-6-4.png" class="img-fluid"></p>
</section>
</section>
<section id="models-help-clarify-complex-data-sets" class="level2">
<h2 class="anchored" data-anchor-id="models-help-clarify-complex-data-sets">Models help clarify complex data-sets</h2>
<section id="effect-size-often-has-to-been-seen-to-be-understood" class="level3">
<h3 class="anchored" data-anchor-id="effect-size-often-has-to-been-seen-to-be-understood">Effect size often has to been seen to be understood</h3>
<p>When doing confirmatory analysis, we might want to know how strong an effect is. Data viz is very useful for this task. Lets compare two datasets that have similar p-values, but very different effect sizes</p>
<pre><code>set.seed(42)
x &lt;- rnorm(1000)
set.seed(420)
y &lt;- 5*x + 3 + rnorm(1000, sd = 15)
set.seed(420)
y2 &lt;- 5*x + 3 + rnorm(1000, sd = 1)

mod1 &lt;- lm(y ~ x)
mod2 &lt;- lm(y2 ~ x)

#Compare the pvalues on the slopes
summary(mod1)

##
## Call:
## lm(formula = y ~ x)
##
## Residuals:
##     Min      1Q  Median      3Q     Max
## -43.201 -10.330   0.395   9.634  46.694
##
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)   2.8054     0.4614   6.080 1.71e-09 ***
## x             4.2096     0.4603   9.145  &lt; 2e-16 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
##
## Residual standard error: 14.59 on 998 degrees of freedom
## Multiple R-squared:  0.07732,    Adjusted R-squared:  0.07639
## F-statistic: 83.63 on 1 and 998 DF,  p-value: &lt; 2.2e-16

summary(mod2)

##
## Call:
## lm(formula = y2 ~ x)
##
## Residuals:
##      Min       1Q   Median       3Q      Max
## -2.88004 -0.68868  0.02634  0.64229  3.11291
##
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)  2.98703    0.03076   97.11   &lt;2e-16 ***
## x            4.94731    0.03069  161.21   &lt;2e-16 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
##
## Residual standard error: 0.9724 on 998 degrees of freedom
## Multiple R-squared:  0.963,  Adjusted R-squared:  0.963
## F-statistic: 2.599e+04 on 1 and 998 DF,  p-value: &lt; 2.2e-16

par(mfrow = c(1,2))
plot(x,y, pch = 16, col = grey(0.5,0.5), las = 1)
abline(mod1, lwd = 2, col = 'red')
plot(x,y2, pch = 16, col = grey(0.5,0.5), las = 1)
abline(mod2, lwd = 2, col = 'red')</code></pre>
<p><img src="dataviz2018_notes_files/figure-markdown_strict/unnamed-chunk-7-1.png" class="img-fluid"></p>
</section>
</section>
<section id="superplots" class="level2">
<h2 class="anchored" data-anchor-id="superplots">Superplots</h2>
<p>Andrew Gelman coined the term <a href="http://andrewgelman.com/2009/05/24/handy_statistic/">superplots</a> for plotting different models on multiple panels of a graph so you can visually compare them.</p>
<p>For instance, say we have several time-series and we want to know if they deviate from each other signficantly. An easy way to compare them is to fit splines to each time-series and then just plot them next to each other, with SEs. Then we can compare visually for ‘signficant’ differences.</p>
<p>Here’s some code to simulate three made-up series. The first two have the same trend, but different observation errors, the third has a different trend:</p>
<pre><code>tmax &lt;- 50
drift &lt;- c(10, -5)
sd &lt;- 40
sdobs &lt;- 200
set.seed(5)
yzero &lt;-  cumsum(rnorm(n=tmax, mean=drift[1], sd=sd))
y1 &lt;- yzero + rnorm(n = tmax, mean = 0, sd = sdobs)
y2 &lt;- yzero + rnorm(n = tmax, mean = 0, sd = sdobs)
y3 &lt;- cumsum(rnorm(n=tmax, mean=drift[2], sd=sd)) +
  rnorm(n = tmax, mean = 0, sd = sdobs)
dat &lt;- data.frame(ts = rep(letters[1:3], each = tmax), x = rep(1:tmax, 3), y = c(y1, y2, y3))</code></pre>
<p>We can easily plot these three series using <code>ggplot2</code> and automatically add a spline.</p>
<pre><code>library(ggplot2)
ggplot(dat, aes(x = x, y = y)) +
    geom_point() +
    facet_grid(.~ts) +
    stat_smooth(method = "loess", se = TRUE) +
   theme(axis.text = element_text(size=14),
        axis.title = element_text(size=16,face="bold"),
          strip.text.x = element_text(size = 16),
          panel.background = element_rect(fill = 'white', colour = 'white'))</code></pre>
<p><img src="dataviz2018_notes_files/figure-markdown_strict/unnamed-chunk-9-1.png" class="img-fluid"></p>
</section>
<section id="length-is-most-accurate" class="level2">
<h2 class="anchored" data-anchor-id="length-is-most-accurate">Length is most accurate</h2>
<p>Ways of comparing data in order from most accurate (top) to more generic (bottom).</p>
<p><img src="dataviz2018_notes_files/figure-markdown_strict/unnamed-chunk-10-1.png" class="img-fluid"></p>
</section>
<section id="comparing-volume-and-area" class="level2">
<h2 class="anchored" data-anchor-id="comparing-volume-and-area">Comparing volume and area</h2>
<p>Compare these. Note that if we compare circles we should use area, not the radius or diameter to scale their size.</p>
<pre><code>n &lt;- c(10, 5)
barplot(n, col = 'skyblue', xaxt = 'n', yaxt = 'n')</code></pre>
<p><img src="dataviz2018_notes_files/figure-markdown_strict/unnamed-chunk-11-1.png" class="img-fluid"></p>
<pre><code>rad1 &lt;- 1
area1 &lt;- pi*(rad1^2)
area2 &lt;- area1/2
rad2 &lt;- sqrt(area2/pi)

par(mfrow = c(1,2), mar = c(0,0,0,0))
pie(1, col = 'skyblue', labels = NA, border = NA, radius = rad1)
pie(1, col = 'skyblue', labels = NA, border = NA, radius = rad2)</code></pre>
<p><img src="dataviz2018_notes_files/figure-markdown_strict/unnamed-chunk-11-2.png" class="img-fluid"></p>
<section id="exploration-of-data" class="level3">
<h3 class="anchored" data-anchor-id="exploration-of-data">Exploration of data</h3>
<p>Let’s create a point cloud to demonstrate some data exploration techniques</p>
<pre><code>set.seed(42)
x &lt;- rnorm(1000)
y &lt;- 5*x + 3 + rnorm(1000, sd = 15)
plot(x,y, pch = 16, col = grey(0.5,0.5), las = 1)</code></pre>
<p><img src="dataviz2018_notes_files/figure-markdown_strict/unnamed-chunk-12-1.png" class="img-fluid"></p>
<p>Can’t see alot here. A linear model might help us explore if there is any trend going on:</p>
<pre><code>mod1 &lt;- lm(y ~ x)
plot(x,y, pch = 16, col = grey(0.5,0.5), las = 1)
abline(mod1, lwd = 2, col = 'red')

xnew &lt;- seq(min(x), max(x), length.out = 100)
pmod &lt;- predict(mod1, newdata =data.frame(x=xnew),  se = T)
lines(xnew, pmod$fit + pmod$se.fit, lwd = 2, col = 'red', lty = 2)
lines(xnew, pmod$fit - pmod$se.fit, lwd = 2, col = 'red', lty = 2)</code></pre>
<p><img src="dataviz2018_notes_files/figure-markdown_strict/unnamed-chunk-13-1.png" class="img-fluid"></p>
<p>What about identifying extreme points, that may be worth investigating further? We can pick out points that are greater than 2SDs from the trend:</p>
<pre><code>modresid &lt;- resid(mod1)
sd2 &lt;- sd(modresid)*2
ipt &lt;- which(abs(modresid) &gt; sd2)

plot(x,y, pch = 16, col = grey(0.5,0.5), las = 1)
abline(mod1, lwd = 2, col = 'red')
points(x[ipt], y[ipt], pch = 16, col = rgb(1,0,0, 0.6))</code></pre>
<p><img src="dataviz2018_notes_files/figure-markdown_strict/unnamed-chunk-14-1.png" class="img-fluid"></p>
</section>
<section id="the-problem-with-bar-charts" class="level3">
<h3 class="anchored" data-anchor-id="the-problem-with-bar-charts">The problem with bar charts</h3>
<p>Here is an interesting <a href="https://www.nature.com/articles/nmeth.2837">blog on the problem with barcharts</a>.</p>
<p>First, let’s generate some data to play with, it has three variables x, y and z.</p>
<pre><code>n &lt;- 40
x &lt;- rnorm(n, mean = 20, sd = 8)
y &lt;- rnorm(n, mean = 20, sd = 3)
z &lt;- rnorm(n, mean = 10, sd = 8)

dat &lt;- data.frame(grp = c(rep("x", n), rep("y", n), rep("z", n)),
                          val = c(x,y,z))</code></pre>
<p>Now compare these three charts, the first is just the means:</p>
<pre><code>sdat &lt;- dat %&gt;% group_by(grp) %&gt;%
  summarize(val = mean(val))

plot(1:3, sdat$val, type = 'p', xaxt = "n", xlab = '', ylab = '',
     las = 1, cex.axis = 1.5, pch = 16, cex = 2)
axis(1, at = 1:3, labels = sdat$grp, cex.axis = 1.5)</code></pre>
<p>The second has standard errors and so captures some of the variation in our data :</p>
<pre><code>ggplot(dat, aes(x = grp, y = val)) +
  stat_summary(fun.data = "mean_se", size = 1.3) +
  xlab("Group") +
  ylab("Values") +
  theme_bw() +
  theme(axis.text=element_text(size=16),
       axis.title=element_text(size=18))</code></pre>
<p><img src="dataviz2018_notes_files/figure-markdown_strict/unnamed-chunk-17-1.png" class="img-fluid"></p>
<p>The third has boxplots, so is perhaps the most truthful, because it shows quantiles and the full range of the data (which is much broader than just the SEs).</p>
<pre><code>ggplot(dat, aes(x = grp, y = val)) +
  geom_boxplot(color = "black") +
  xlab("Group") +
  ylab("Values") +
  theme_bw() +
  theme(axis.text=element_text(size=16),
        axis.title=element_text(size=18))</code></pre>
<p><img src="dataviz2018_notes_files/figure-markdown_strict/unnamed-chunk-18-1.png" class="img-fluid"></p>
</section>
<section id="dont-waste-digital-ink" class="level3">
<h3 class="anchored" data-anchor-id="dont-waste-digital-ink">Don’t waste digital ink</h3>
<p>Plots with less ‘add-ons’ tend to communicate the key message more clearly. For instance, just like excel plots dont:</p>
<pre><code>x &lt;- rnorm(100)
dat &lt;- data.frame(x = x, y = 0.25*x + rnorm(100, sd = 0.2))

library(ggplot2)
library(ggthemes)
ggplot(dat, aes(x = x, y = y)) + geom_point() +
    theme_excel() + theme(axis.text=element_text(size=20),
        axis.title=element_text(size=20))</code></pre>
<p><img src="dataviz2018_notes_files/figure-markdown_strict/unnamed-chunk-19-1.png" class="img-fluid"></p>
<p>You can get additional themes for ggplot2 using <a href="https://cran.r-project.org/web/packages/ggthemes/vignettes/ggthemes.html">this excellent package</a>.<br>
A cleaner view:</p>
<pre><code>ggplot(dat, aes(x = x, y = y)) + geom_point() +
    theme_base() + theme(axis.text=element_text(size=20),
        axis.title=element_text(size=20))</code></pre>
<p><img src="dataviz2018_notes_files/figure-markdown_strict/unnamed-chunk-20-1.png" class="img-fluid"></p>
<p>Or simply:</p>
<pre><code>plot(dat$x, dat$y, xlab = "x", ylab = "y", las = 1)</code></pre>
<p><img src="dataviz2018_notes_files/figure-markdown_strict/unnamed-chunk-21-1.png" class="img-fluid"></p>
<p>A good principle is to not use ‘ink’ on figures that isn’t needed to communicate your message. <a href="https://www.edwardtufte.com/tufte/">Tufte</a> takes the ‘less ink’ philosophy to the extreme:</p>
<pre><code>ggplot(dat, aes(x = x, y = y)) + geom_point() +
    theme_tufte() + theme(axis.text=element_text(size=20),
        axis.title=element_text(size=20))</code></pre>
<p><img src="dataviz2018_notes_files/figure-markdown_strict/unnamed-chunk-22-1.png" class="img-fluid"></p>
</section>
<section id="when-is-ggplot2-appropriate-or-when-should-i-use-base-r" class="level3">
<h3 class="anchored" data-anchor-id="when-is-ggplot2-appropriate-or-when-should-i-use-base-r">When is ggplot2 appropriate, or when should I use base R?</h3>
<p>In general I think <a href="http://ggplot2.org/">ggplot2</a> is appropriate for problems of intermediate complexity. Like this:</p>
<p><img src="dataviz2018_notes_files/figure-markdown_strict/unnamed-chunk-23-1.png" class="img-fluid"> Base R is great if you just want to plot a barplot quickly, or do an x-y plot. ggplot2 comes into its own for slight more complex plots, like having multiple panels for different groups or colouring lines by a 3rd factor. But once you move to really complex plots, like overlaying a subplot on a map, ggplot2 becomes very difficult, if not impossible. At that point it is better to move back to Base R. ggplot2 can also get very fiddly if you are very specific about your plots, like having certain colours, or the labels in a certain way.</p>
<p>As an example, ggplot2 is great for data like this:</p>
<pre><code>x1 &lt;- rnorm(30)
grps &lt;- letters[c(rep(1, 10), rep(2, 10), rep(3, 10))]
y1 &lt;- x1 + c(rep(1, 10), rep(-1, 10), rep(2, 10)) + rnorm(30)
dat &lt;- data.frame(x = x1, grps = grps, y = y1)
head(dat)

##            x grps         y
## 1  0.3293278    a 1.5458494
## 2 -0.2975122    a 0.5877379
## 3  1.1849880    a 2.2053261
## 4  1.3095354    a 3.2023256
## 5 -1.1704553    a 1.2776289
## 6  0.9961189    a 1.7440880

ggplot(dat, aes(x = x1, y = y1, color = grps)) +
  geom_point() + theme_bw()</code></pre>
<p><img src="dataviz2018_notes_files/figure-markdown_strict/unnamed-chunk-24-1.png" class="img-fluid"></p>
<p>It is also pretty handy for faceting:</p>
<pre><code>ggplot(dat, aes(x = x1, y = y1)) +
  geom_point() + facet_grid(.~grps)+
  theme_bw()</code></pre>
<p><img src="dataviz2018_notes_files/figure-markdown_strict/unnamed-chunk-25-1.png" class="img-fluid"></p>
<p>The key with ggplot2 is to have your data in a data-frame.</p>
<p>In reality both ggplot2 and base R graphics are worth learning, but I would start with learning the basics of base R graphics and then move onto ggplot2 if you want to quickly plot lots of structured data-sets.</p>
</section>
<section id="pie-graphs-vs-bar-graphs" class="level3">
<h3 class="anchored" data-anchor-id="pie-graphs-vs-bar-graphs">Pie graphs vs bar graphs</h3>
<p>In Mariani et al.&nbsp;they plot rates of seafood fraud by several European countries. While its a foundational study that establishes improvement in the accuracy of food labelling, their graphics could be improved in several ways.</p>
<p>First they use perspective pies. This makes it incredibly hard to compare the two groups (fish that are labelled/mislabelled). Humans are very bad at comparing angles and pretty bad at comparing areas. With the perspective you can’t even compare the areas properly. They do provide the raw numbers, but then, why bother with the pies?<br>
Note that the % pies misrepresent the data slightly because the % figures are actually odds ratios (mis-labels / correct labels), rather than percent (mis-labeels / total samples).<br>
Second the pies are coloured red/green, which will be hard for red-green colourblind people to see.<br>
Third, they have coloured land blue on their map, so it appears to be ocean at first look.<br>
Fourth, the map is not really neccessary. There are no spatial patterns going on that the authors want to draw attention to. I guess having a map does emphasize that the study is in Europe. Finally, the size of each pie is scaled to the sample size, but the scale bar for the sample size shows a sample of only 30, whereas most of their data are for much larger samples sizes (&gt;200). Do you get the impression from the pies that the UK has 668 samples, whereas Ireland only has 187? Therefore, from this graphic we have no idea what sample size was used in each country.</p>
<p>In fact, all the numbers that are difficult to interpret in the figure are very nicely presented in Table 1.</p>
<p>Below is a start at improving the presentation. For instance, you could do a simple bar chart, ordering by rate of mislabelling.</p>
<pre><code>cnames &lt;- c('Ireland' ,'UK','Germany','France','Spain','Portugal')
corrlab &lt;- c(180, 647, 145, 146, 267, 178)
mislab &lt;- c(7, 21, 9, 4, 24, 12)
misrate &lt;- 100*signif(mislab / (corrlab + mislab),2)                  
corrrate &lt;- 100 - misrate
ord &lt;- order(misrate, decreasing = T)
y &lt;- rbind(corrrate, misrate)

par(mar = c(5,4,4,7))
barplot(y[,ord], names.arg = cnames[ord], col = c('skyblue','tomato'), ylab = 'Labelling rate (%)', las = 2)
legend(x=7.5, y = 90, legend = c("Mislabelled", "Correctly labelled"), pch = 16, col = c('tomato','skyblue'), xpd = NA, cex = 0.7)</code></pre>
<p><img src="dataviz2018_notes_files/figure-markdown_strict/unnamed-chunk-26-1.png" class="img-fluid"></p>
<p>You could add another subfigure to this, showing the rate by different species too.</p>
<p>The barplot doesn’t communicate the sample size, but then that is probably not the main point. The sample sizes are probably best reported in the table</p>
<p>If we felt the map was essential, then putting barcharts on it would be more informative. It is not that easy to add barcharts ontop of an existing map in R, so I would recommend creating the barcharts seperately, then adding them on in Illustrator or Powerpoint.</p>
<p>We can make a basic map like this:</p>
<pre><code>library(maps)
library(maptools)
map('world', xlim = c(-20, 20), ylim = c(35, 60), col = 'grey', fill = T)</code></pre>
<p><img src="dataviz2018_notes_files/figure-markdown_strict/unnamed-chunk-27-1.png" class="img-fluid"></p>
<p>Then create some nice barcharts. We write a loop so we get one barchart for each country.</p>
<pre><code>nc &lt;- length(cnames)
par(mfrow = c(2,3), oma = c(1,1,1,3))
for (i in 1:nc){
  y &lt;- c(mislab[i], corrlab[i])
  barplot(y, names.arg = '', las = 2, col = c('tomato','skyblue'), ylim = c(0, corrlab[i]), main = cnames[i], cex.main = 2.4, yaxt = 'n')
  byy &lt;- signif(max(y),2)/3
  yat &lt;- c(0, min(y), max(y))
axis(2, at = yat, las = 2, cex.axis = 2, labels = F)  
axis(2, at = yat[2:3], las = 2, cex.axis = 2, labels = T)  
}
legend(x = 2.8, y = 500, legend = c('Fraud', 'Correct'), pch = 15, col = c('tomato','skyblue'), xpd = NA, cex = 2, bty = 'n')</code></pre>
<p><img src="dataviz2018_notes_files/figure-markdown_strict/unnamed-chunk-28-1.png" class="img-fluid"></p>
</section>
<section id="scaling-matters" class="level3">
<h3 class="anchored" data-anchor-id="scaling-matters">Scaling matters</h3>
<p>It can be misleading to present % and proportion data on axes that are not scaled 0 - 100%. For instance, compare these three graphs:</p>
<pre><code>y &lt;- c(70, 72, 68, 73)
x &lt;- 1:4
xnams &lt;- LETTERS[1:4]

par(mfrow = c(1,3), oma = c(1,1,1,3), mar = c(5,6,2,2))
plot(x,y, pch = 3, cex = 2, las = 1, xaxt  = 'n', xlab = '', ylab = 'Percent', cex.axis = 2, cex.lab = 2, tcl = 0.5, xlim = c(0, 5), col = 'red', lwd = 3)
axis(1, at = x, labels = xnams, cex.axis = 2, tcl = 0.5)

barplot(y, names.arg = xnams, las = 1, cex.axis = 2, cex.lab = 2, cex.names = 2, ylab = 'Percent')

barplot(y, names.arg = xnams, las = 1, cex.axis = 2, cex.lab = 2, cex.names = 2, ylab = 'Percent', ylim = c(0, 100))</code></pre>
<p><img src="dataviz2018_notes_files/figure-markdown_strict/unnamed-chunk-29-1.png" class="img-fluid"></p>
</section>
</section>
<section id="interpreting-rates" class="level2">
<h2 class="anchored" data-anchor-id="interpreting-rates">Interpreting rates</h2>
<p><strong>The units you use affect how people interpret your graph</strong>.<br>
People are bad at interpreting rates, we just can’t get our heads around accumulation very well. Here is a numerical example. Check out the below figure and ask yourself:</p>
<blockquote class="blockquote">
<p>At what time is the number of people in the shopping centre declining?</p>
</blockquote>
<p><img src="dataviz2018_notes_files/figure-markdown_strict/interpreting-rates-1.png" class="img-fluid"></p>
<p>Would you say it is at point A, B, C or D?</p>
<p>Let’s plot the total number of people:</p>
<p><img src="dataviz2018_notes_files/figure-markdown_strict/unnamed-chunk-30-1.png" class="img-fluid"></p>
<p>Hopefully the answer is obvious now. So the right scales can help make interpretation much easier.</p>
<p>You could also rephrase the question from when is the total number decreasing to when is the number entering less than the number of people leaving?</p>
</section>
<section id="choosing-colour-scales" class="level2">
<h2 class="anchored" data-anchor-id="choosing-colour-scales">Choosing colour scales</h2>
<p>Alot of thought should go into choosing colour scales for graphs for instance- will it print ok? will colour blind people be able to see this? does the scale create artificial visual breaks in the data? Luckily there is a package to help you make the right decision for a colour scale, it is called <code>RColorBrewer</code>. Check out colorbrewer.org for a helpful interactive web interface for choosing colours.</p>
<p>First let’s load some <a href="../../data/sst-data.zip">sea surface temperature</a> data as a raster:</p>
<pre><code>library(raster)
r &lt;- raster("MeanAVHRRSST")

library(RColorBrewer)
par(mfrow = c(1,2))
plot(r, col = rev(brewer.pal(11, "Spectral")), asp = NA)
plot(r, col = brewer.pal(11, "Purples"), asp = NA)

## Warning in brewer.pal(11, "Purples"): n too large, allowed maximum for palette Purples is 9
## Returning the palette you asked for with that many colors</code></pre>
<p><img src="dataviz2018_notes_files/figure-markdown_strict/unnamed-chunk-32-1.png" class="img-fluid"></p>
<p>Using red-green palettes makes it hard for colour blind people. Also, using a diverging palette makes it look like there is something important about the middle point (yellow). A better palette to use would be one of the sequential ones, “Purples” shown here.</p>
<p>To make it easier to understand, let’s look at these again as contour plots. I will use a more appropriate diverging palette to the red-green one though.</p>
<pre><code>z &lt;- matrix(rep(1:10, 10), nrow = 10)
filled.contour(z, col = brewer.pal(9, 'Reds'), nlevels = 10)</code></pre>
<p><img src="dataviz2018_notes_files/figure-markdown_strict/unnamed-chunk-33-1.png" class="img-fluid"></p>
<pre><code>filled.contour(z, col = brewer.pal(9, 'RdBu'), nlevels = 10)</code></pre>
<p><img src="dataviz2018_notes_files/figure-markdown_strict/unnamed-chunk-33-2.png" class="img-fluid"></p>
<p>Notice the diverging pallette creates an artificial split at yellow</p>
<p>One of the only legitimate uses for pie graphs (I think) is visualising the colour scales. Here is how:</p>
<pre><code>reds &lt;- brewer.pal(9, 'Reds')
greens &lt;- brewer.pal(9, 'Greens')
blues &lt;- brewer.pal(9, 'Blues')
rdylgn &lt;- brewer.pal(9, 'RdYlGn')
rdbu &lt;- brewer.pal(9, 'RdBu')
dark2 &lt;- brewer.pal(8, 'Dark2')

par(mfrow = c(2,3), mar = c(0,0,0,0), oma = c(0,0,0,0))
pie(rep(1, 9), col = reds)
pie(rep(1, 9), col = greens)
pie(rep(1, 9), col = blues)
pie(rep(1, 9), col = rdylgn)
pie(rep(1, 9), col = rdbu)
pie(rep(1, 9), col = dark2)</code></pre>
<p><img src="dataviz2018_notes_files/figure-markdown_strict/unnamed-chunk-34-1.png" class="img-fluid"></p>
</section>
<section id="r-the-intergrator" class="level2">
<h2 class="anchored" data-anchor-id="r-the-intergrator">R the intergrator</h2>
<p>In my talk I give some examples of how R can integrate everything from data input, data processing, analysis, visualisation to sharing results (even as interactive web content). The results for the quiz you took above are available as a google spreadsheet. We can use R to read that data and visualise it, and even share the results as a webpage or on Twitter.</p>
<p>Here are the <a href="https://docs.google.com/spreadsheets/d/10i3v3NIVpgmURyLVzsiadPAMGeqa7dLFcDb9sqFe8KA/edit#gid=1513779153">quiz results</a></p>
<p>You can access a google sheet with the <code>googlesheets</code> package:</p>
<pre><code>library(googlesheets)
dataviz &lt;- gs_url("https://docs.google.com/spreadsheets/d/10i3v3NIVpgmURyLVzsiadPAMGeqa7dLFcDb9sqFe8KA/edit#gid=1513779153)")
gsheet &lt;- gs_read(dataviz)</code></pre>
<p>Now the column names are just the questions in the quiz, so let’s rename them for convenience.</p>
<pre><code>newnames &lt;- c("timestamp", "shopping",
              "bar_percent",
              "pie_percent",
              "room",
              "cb_age")
names(gsheet) &lt;- newnames</code></pre>
<p>Now we are ready to do our plots. For instance, to see what people said about my age:</p>
<pre><code>ggplot(gsheet, aes(cb_age)) +
  geom_histogram()</code></pre>
<p>How did people answer the shopping quiz question?</p>
<pre><code>ggplot(gsheet, aes(shopping)) +
  geom_bar()</code></pre>
<p>What about looking at the accuracy of the pie chart vs bar chart question. To do that we first need to calculate an accuracy metric. We will use the <code>dplyr</code> package to do that:</p>
<pre><code>library(dplyr)
library(tidyr)
outcomes &lt;- c(72, 17)
gsheet2 &lt;- gsheet %&gt;%
  mutate(bar_accuracy = abs(bar_percent - outcomes[1]),
    pie_accuracy = abs(pie_percent - outcomes[2])) %&gt;%
  select(bar_accuracy, pie_accuracy, cb_age) %&gt;%
  gather(dataviz, accuracy, -cb_age)</code></pre>
<p>Here accuracy is just the quiz answers minus the correct answer (in <code>outcomes</code>) and then we take its absolute value.</p>
<p>We can plot this like so:</p>
<pre><code>ggplot(gsheet2, aes(dataviz, accuracy)) +
  geom_boxplot()</code></pre>
<p>We could also look to see how accuracy compares to guesses of my age (obviously younger guesses at my age will be more accurate ;)), and plot a model of age vs accuracy:</p>
<pre><code>ggplot(gsheet2, aes(cb_age, accuracy)) +
  geom_point() +
  facet_grid(.~dataviz) +
  stat_smooth()</code></pre>
</section>
<section id="resources-and-further-reading" class="level2">
<h2 class="anchored" data-anchor-id="resources-and-further-reading">Resources and further reading</h2>
<ul>
<li><p><a href="http://www.thefunctionalart.com/p/the-truthful-art-book.html">The Truthful Art by Alberto Cairo</a></p></li>
<li><p><a href="https://www.edwardtufte.com/tufte/">Books by Edward Tufte</a></p></li>
<li><p><a href="https://twitter.com/hashtag/dataviz?src=hash">Twitter #dataviz</a></p></li>
<li><p>An infographic of chart types: <a href="https://github.com/ft-interactive/chart-doctor/blob/master/visual-vocabulary/Visual-vocabulary.pdf">Visual vocabulary</a></p></li>
<li><p><a href="http://viz.wtf">WTF Visualizations</a>, on <a href="https://www.twitter.com/WTFViz">Twitter</a></p></li>
<li><p><a href="https://datavizcatalogue.com/">The dataviz catalogue</a></p></li>
<li><p><a href="http://courses.ischool.berkeley.edu/i247/f05/readings/Cleveland_GraphicalPerception_Science85.pdf">Cleveland and McGill “Graphical Perception of data classic” study published in Science 1985</a></p></li>
</ul>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/www\.seascapemodels\.org");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>